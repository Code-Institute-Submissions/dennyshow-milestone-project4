{% extends 'base.html' %}
{% load mathfilters %}
{% block content %}


<div class="row">
        <!-- HEADER -->
    <h1>My Bids</h1>


            <!-- FOR LOOP -->
            
    {% for b in bid %}
    <div class='col-md-12'>
                <!-- HEADER -->
        <h2 class='border'> {{ b.product_id.title }}</h2>
    </div>
    <div class=" col-md-6  display panel panel-default ">
        <div class="panel-body">
            <div id="myCarousel" class="carousel slide" data-ride="carousel">
                <!-- Indicators -->
                <ol class="carousel-indicators">
                    <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
                    <li data-target="#myCarousel" data-slide-to="1"></li>
                </ol>

                <!-- Wrapper for slides -->
                <div class="carousel-inner">

                    <div class="item active">
                        <img src="{{ MEDIA_URL }}{{ b.product_id.image }}">
                    </div>

                    <div class="item">
                        <img src="http://eskipaper.com/images/leaf-background-1.jpg">
                    </div>

                </div>

                <!-- Left and right controls -->
                <a class="left carousel-control" href="#myCarousel" data-slide="prev">
      <span class="glyphicon glyphicon-chevron-left"></span>
      <span class="sr-only">Previous</span>
    </a>
                <a class="right carousel-control" href="#myCarousel" data-slide="next">
      <span class="glyphicon glyphicon-chevron-right"></span>
      <span class="sr-only">Next</span>
    </a>
            </div>
        </div>
    </div>


    <div class="col-md-6 bid-detail">

        <div>

            <h4>Artefact Description:</h4>
            <span> {{ b.product_id.details }} </span>
            <h4>Artefact Category:</h4>
            <span> {{ b.product_id.artefact }}</span>
        </div>
        
                <!-- FORM START-->
         <form action="{% url 'charge' %}" class="form" method="post" data-name="{{end_time.0}}">
              {% csrf_token %}
              <input type="hidden" name="bid_price" value={{ b.product_id.auction_price }} />
              <input type="hidden" name="bid_product" value={{ b.product_id.id }} />
              <span> Bid Price: â‚¬ {{ b.product_id.auction_price }}</span><br>
              
                  <!--COUNTDOWN TIMER-->
              <p id="message_{{ forloop.counter0 }}" class="font-size" ></p>
              <span id="timer_{{ forloop.counter0 }}"  ></span>
                <!--COUNTDOWN TIMER END-->
                
                  <!-- STRIPE PAYMENT JS-->
              <script src="https://checkout.stripe.com/checkout.js" class="stripe-button"
                      data-key="{{ key }}"
                      data-description="Artefacts Collections"
                      data-amount="{{ b.product_id.auction_price | mul:100 }}"
                      data-locale="auto">
              </script>
              <div id="error"></div>
                  <!-- STRIPE PAYMENT JS ENDS-->
        </form>
                <!-- FORM END-->

    </div>

    <div class="col-md-10">

        <h3 class='border'> Description:</h3><span> {{ b.product_id.details }}</span>
        <h3 class='border'> History: </h3> <span> {{ b.product_id.history }}</span>
 
    </div>






    {% endfor %}
                <!-- FOR LOOP END -->
</div>

                <!-- SCRIPT FOR PAYMENT BUTTON -->
<script type="text/javascript">

    // varible that takes the last bid date and time converts into current time.
var temp = Date.now();

    // varibles that querys the end time of auction in form before allowing payment
var time = document.querySelectorAll(".form");
var timeArray = {{end_time|safe}}

    // varibles that takes the count
var count = 0;

     // function that take count of the time left to pay for bid when not reached
time.forEach(function(a){
  var temp2=Date.parse(timeArray[count]);
              var date2= new Date(timeArray[count]);
               var secondtime = new Date(timeArray[count]).getTime();
               
            // if biding time is greater than current time hide button
  
  var message = document.getElementById("message_"+count)
  if(temp>temp2){
  message.innerHTML="Auction Is Closed!"
  }
             // if biding time is lesser than current time display button
             // countdown timer to display time left before auction can be paid for
             // displays the payment button once the auction ends
  else{
 var countdown =  document.getElementById("timer_"+count);
      a.querySelector("button").style.display = 'none'
    message.innerHTML="Ongoing Live Auction!"    
 x = setInterval(function(){
     let now = new Date().getTime(),
          distance = secondtime - now;
     var date = new Date(Date.now());
     var seconds = Math.floor((date2 - (date))/1000);
var minutes = Math.floor(seconds/60);
var hours = Math.floor(minutes/60);
var days = Math.floor(hours/24);
hours = hours-(days*24);
minutes = minutes-(days*24*60)-(hours*60);
seconds = seconds-(days*24*60*60)-(hours*60*60)-(minutes*60);

countdown.innerHTML= "Days: "+days + " hours: "+hours+" minutes: "+minutes +" seconds: "+ seconds; 
if(distance <=0){
    clearInterval(x)
countdown.innerHTML=""
 message.innerHTML="Auction Won!"
 a.querySelector("button").style.display = 'block'
    
}
 },1000)
 
  }
  count++;
    
})

</script>
        <!-- SCRIPT END -->

<br>
{% endblock %}